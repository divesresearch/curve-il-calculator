<!DOCTYPE html>
<html>
<head>
    <title> Curve IL Calculator </title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
            type="application/javascript"></script>
    <script src="./config.js"> </script>
    <script src="./util.js"> </script>
    <script src="./test.js"> </script>
</head>
<body>

    <div class="box" style="background: #3465a4;">
        <h1> Curve <abbr title="Impermanent Loss">IL</abbr> Calculator </h1> 
    </div>

    <div class="box">
        <fieldset>
            <legend> <b> Calculator </b> </legend>
        <br>
        <center>
            <div class="container"> 
                <div class="custom-select">
                    <select id="blockchains">
                        <option value="" disabled selected>
                            Select a Blockchain 
                        </option>
                    </select>
                </div>
                <div class="custom-select">
                    <select name="pools" id="pools">
                        <option value="" disabled selected>
                            Select a Pool 
                        </option>
                    </select>
                </div>
            </div>
            <br>
            <input class="text" id="initial_price" name="fname" value=""
            placeholder="Initial Price">
            <input class="text" id="final_price" name="fname" value=""
            placeholder="Final Price">
            <br> <br> 
            <button id="calculate"> Calculate </button>
            <div id="result" style="margin-top: 15x;"> 
            </div>
        </center>
        </fieldset>
    </div>

    <div class="box">
        <fieldset>
            <legend> <b> Info/Disclaimer </b> </legend>
            <p> This app is not an official app audited by
            Curve.fi and is developed by Dives Research voluntarily. </p> 
        </fieldset>
    </div>

    <div style=" white; position: fixed; bottom: 0; right: 0; width: 100%;">
        <center>
            <a href="https://www.dives.fyi"><img src="images/dives.png"
                class="icon"></a> 
            <a href="https://github.com/orgs/divesresearch/repositories"><img
                src="images/github.png" class="icon"></a>
            <a href="https://twitter.com/DivesResearch"><img
               src="images/twitter.png" class="icon"/></a>
            <a href="https://t.me/divesresearch"><img src="images/telegram.png"
                class="icon"/></a>
        </center>
    </div>
    <script>
        const
            [blockchains, pools, calculate, result] = 
                ["blockchains", "pools", "calculate", "result"]
                    .map( id => document.getElementById(id) )

        chainDatas
            .map( ({chain_name : name})  => { 
                const option = document.createElement("option")
                option.text = name
                return option
            })
            .forEach( (option) => 
                blockchains.add( option )
            )

        blockchains.addEventListener('click', () => {
            const 
                chainName = 
                    blockchains.options[blockchains.selectedIndex].value,
                poolNames =
                    poolDatas
                        .filter(poolData => poolData.chain == chainName)
                        .map(({name}) => name )

            for(let i = pools.options.length - 1; i > 0; i--) {
                pools.remove(i);
            }
                    
            for(const pName of poolNames){
                const option = document.createElement("option")
                option.text = pName
                pools.add(option) 
            }
        })

        calculate.addEventListener('click', async () => {
            
            result.innerHTML = '<img src="images/clock.gif" width="30px" \
                    height="30px"/>'
            const 
                [chainName, poolName] = 
                    [blockchains, pools]
                        .map( selector => 
                            selector.options[selector.selectedIndex].value ),

                [initPrice, finalPrice] = 
                    ['initial_price', 'final_price']
                        .map( id => document.getElementById(id).value )
                        .map( parseFloat ),
            
                {A, n} = await fetchPoolDatas(chainName, poolName),

                loss = calculateIL(A, 1, initPrice, finalPrice, n)
            
                result.innerText = `Impermanent Loss: ${parseFloat(loss).toFixed(2)}% `
        })
        
    </script>

</body>
</html>
